<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XiaoYou AI Â· Ultimate Sci-Fi Edition</title>
<style>
:root {
  --bg1: #06070d;
  --bg2: #0e1429;
  --accent1: #7c3aed;
  --accent2: #06b6d4;
  --text: #e8ecf8;
  --muted: rgba(230,238,248,0.65);
  --panel: rgba(255,255,255,0.02);
  --border: rgba(255,255,255,0.05);
  --transition: 420ms cubic-bezier(.25,.9,.25,1);
}
:root.light-theme {
  --bg1: #f7f8fc;
  --bg2: #e8edf6;
  --text: #0a1020;
  --muted: rgba(10,16,32,0.6);
  --panel: rgba(255,255,255,0.7);
  --border: rgba(0,0,0,0.05);
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;}
body {
  background: linear-gradient(120deg,var(--bg1),var(--bg2));
  font-family: Inter,"SF Pro Text",Roboto,"Helvetica Neue",Arial;
  color: var(--text);
  display:flex;align-items:center;justify-content:center;
  padding:20px;
  transition: background var(--transition),color var(--transition);
  overflow:hidden;
}
.bg-animated{
  position:fixed;inset:-20%;z-index:0;pointer-events:none;
  background:
    radial-gradient(600px 400px at 10% 20%,rgba(124,58,237,0.15),transparent 8%),
    radial-gradient(500px 350px at 90% 80%,rgba(6,182,212,0.1),transparent 8%);
  filter: blur(30px) saturate(130%);
  animation:floatBG 28s linear infinite alternate;
  mix-blend-mode:screen;
}
@keyframes floatBG{
  0%{transform:translate(0,0) scale(1);}
  50%{transform:translate(4%,-3%) scale(1.05);}
  100%{transform:translate(0,0) scale(1);}
}

.app {
  width:100%;max-width:950px;position:relative;z-index:2;
  display:grid;grid-template-rows:auto 1fr auto;gap:16px;
}
.header {
  display:flex;justify-content:center;align-items:center;position:relative;
  background:var(--panel);backdrop-filter:blur(8px);
  border:1px solid var(--border);border-radius:14px;
  padding:14px 16px;
}
.header h1{font-size:18px;font-weight:600;}
.header p{font-size:12px;color:var(--muted);margin-top:3px;text-align:center;}
.theme-toggle{
  position:absolute;left:16px;top:12px;width:50px;height:30px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  background:var(--panel);border:1px solid var(--border);transition:all var(--transition);
}
.theme-toggle svg{width:20px;height:20px;transition:all .4s ease;}
.icon-moon{position:absolute;opacity:1;transform:scale(.8);}

.panel{
  display:flex;flex-direction:column;min-height:60vh;
  background:var(--panel);backdrop-filter:blur(12px);
  border:1px solid var(--border);border-radius:16px;
  box-shadow:0 10px 40px rgba(0,0,0,0.4);
  overflow:hidden;
}
#chat{
  flex:1;overflow-y:scroll;padding:20px;display:flex;flex-direction:column;gap:12px;
  scroll-behavior:smooth;
  min-height: 60vh;
  max-height: 70vh;
  height: auto;
}
/* Enhance scrollbar visibility - Chrome, Edge, Safari */
#chat::-webkit-scrollbar{
  width: 14px;
  background: rgba(255,255,255,0.1);
}
#chat::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg,var(--accent1),var(--accent2));
  border-radius: 7px;
  box-shadow:0 0 15px var(--accent1);
  opacity: 1;
  border: 2px solid transparent;
  background-clip: padding-box;
}
#chat::-webkit-scrollbar-thumb:hover{
  opacity: 1;
  background-color: var(--accent2);
}
#chat::-webkit-scrollbar-track{
  background: rgba(255,255,255,0.1);
  border-radius: 7px;
}
#chat::-webkit-scrollbar-corner {
  background: transparent;
}
/* Add scrollbar styles for Firefox */
#chat{
  scrollbar-width: 14px;
  scrollbar-color: var(--accent2) rgba(255,255,255,0.1);
}

.message{
  max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.45;
  word-break:break-word;animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.user{
  margin-left:auto;background:linear-gradient(135deg,var(--accent2),var(--accent1));
  color:white;border-radius:14px 14px 6px 14px;box-shadow:0 6px 20px rgba(99,102,241,.25);
}
.assistant{
  margin-right:auto;background:rgba(255,255,255,.03);border:1px solid var(--border);
  border-radius:14px 14px 14px 6px;transition:transform .3s;
}
.assistant:hover{transform:translateY(-2px);}
.system-message{margin:0 auto;color:var(--muted);font-size:13px;}

.typing-indicator{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;
  background:rgba(255,255,255,0.02);border:1px solid var(--border);
  border-radius:12px;animation:breathe 3s infinite;
}
@keyframes breathe{0%,100%{opacity:.9;}50%{opacity:.6;}}
.dots{display:inline-flex;gap:3px;}
.dots span{width:6px;height:6px;border-radius:50%;
  background:linear-gradient(180deg,var(--accent1),var(--accent2));
  animation:dot 1s infinite ease-in-out;
}
.dots span:nth-child(2){animation-delay:.15s;}
.dots span:nth-child(3){animation-delay:.3s;}
@keyframes dot{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}

.input-row{
  display:flex;gap:10px;align-items:center;padding:12px;
  background:rgba(255,255,255,0.02);border-top:1px solid var(--border);
}
.voice-btn{
  width:42px;height:42px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  border:none;color:white;cursor:pointer;display:flex;
  align-items:center;justify-content:center;transition:transform .2s;
}
.voice-btn:hover{transform:scale(1.05);}
.voice-btn:active{transform:scale(0.95);}
#user-input{
  flex:1;padding:12px 16px;border-radius:999px;
  border:1px solid var(--border);background:rgba(255,255,255,0.02);
  color:var(--text);font-size:15px;outline:none;transition:box-shadow .3s,border .3s;
}
#user-input:focus{
  border-color:var(--accent2);
  box-shadow:0 0 10px rgba(6,182,212,.3);
}
.button-send{
  padding:10px 16px;border:none;border-radius:999px;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:white;font-weight:600;cursor:pointer;position:relative;overflow:hidden;
}
.button-send:after{
  content:"";position:absolute;inset:0;border-radius:inherit;
  background:radial-gradient(circle,rgba(255,255,255,.4),transparent 60%);
  opacity:0;transform:scale(0);transition:transform .5s,opacity .5s;
}
.button-send:active:after{opacity:1;transform:scale(2);}

@media(max-width:720px){.app{padding:12px;}}
</style>
</head>
<body>
<div class="bg-animated"></div>
<div class="app">
  <header class="header">
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Theme">
      <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="#FFD166"/><g stroke="#FFD166" stroke-width="1.2"><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/></g></svg>
      <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#B0C4DE"/></svg>
    </button>
    <div class="title"><h1>XiaoYou AI</h1></div>
  </header>

  <main class="panel">
    <section id="chat" aria-live="polite"></section>
    <div class="input-row">
      <!-- Temporarily removed voice input button as SST is not supported -->
        <!-- <button id="voice-btn" class="voice-btn" aria-label="Voice Input">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="22"></line>
          </svg>
        </button> -->
      <input id="user-input" placeholder="Type your message..." />
      <button id="send-btn" class="button-send">Send</button>
    </div>
  </main>
</div>

<script>
const chat=document.getElementById('chat');
const input=document.getElementById('user-input');
const sendBtn=document.getElementById('send-btn');
const themeToggle=document.getElementById('themeToggle');
const WS_URL="ws://localhost:6789";
let ws=null,typingElem=null,typingShown=false;

// helper
function createMsg(txt,cls){const d=document.createElement('div');d.className='message '+cls;d.textContent=txt;return d;}
function scrollBottom(){chat.scrollTop=chat.scrollHeight;}

function showTyping(){
  if(typingShown)return;typingShown=true;
  typingElem=document.createElement('div');
  typingElem.className='typing-indicator assistant';
  typingElem.innerHTML='<strong>XiaoYou</strong><span> is thinking</span><div class="dots"><span></span><span></span><span></span></div>';
  chat.appendChild(typingElem);scrollBottom();
}
function hideTyping(){
  if(!typingShown)return;typingShown=false;
  typingElem.style.opacity='0';setTimeout(()=>typingElem.remove(),250);
}

function sendMsg(){
  const t=input.value.trim();if(!t)return;input.value='';
  chat.appendChild(createMsg(t,'user'));scrollBottom();showTyping();
  if(ws&&ws.readyState===1){ws.send(JSON.stringify({message:t}));}
  else setTimeout(hideTyping,1000);
}

input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
sendBtn.addEventListener('click',sendMsg);

// Voice output functionality - playing local audio files
function addPlayButton(messageElement, audioUrl){
  const playBtn=document.createElement('button');
  playBtn.className='play-btn';
  playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
  playBtn.style.cssText=`
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text);
    opacity: 0;
    transition: opacity 0.3s;
  `;
  
  messageElement.style.position='relative';
  messageElement.appendChild(playBtn);
  
  messageElement.addEventListener('mouseenter',()=>{
    playBtn.style.opacity='1';
  });
  
  messageElement.addEventListener('mouseleave',()=>{
    playBtn.style.opacity='0';
  });
  
  playBtn.addEventListener('click',(e)=>{
    e.stopPropagation();
    if(audioUrl){
      const audio=new Audio(audioUrl);
      audio.play().catch(error=>{
        console.error('Audio playback failed:', error);
      });
    }
  });
}

// Modify message receiving logic to handle content and audio files
function receiveMessage(content, audioFile){
  hideTyping();
  const messageElement=createMsg(content,'assistant');
  chat.appendChild(messageElement);
  scrollBottom();
  
  // If there's an audio file, add a play button
  if(audioFile){
    // Construct URL path for audio file
    const audioUrl=`/voice/${audioFile}`;
    addPlayButton(messageElement, audioUrl);
  } else {
    // Show play button even without audio file to prompt user
    addPlayButton(messageElement, null);
  }
}

// websocket
function connect(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{chat.appendChild(createMsg('[System] Connected','system-message'));scrollBottom();};
  ws.onmessage=(e)=>{
    try{const d=JSON.parse(e.data);
      if(d.message==='__heartbeat__'||JSON.stringify(d)==='{}'||JSON.stringify(d)==='[]')return;
      // Check if there's a voice file path
      const audioFile=d.audio_file||d.audioFile||null;
      if(d.response||d.content){receiveMessage(d.response||d.content, audioFile);}
    }catch{ if(e.data.trim()==='{}'||e.data.trim()==='[]')return; receiveMessage(e.data, null); }
  };
  let reconnectionAttempts = 0;
  const maxReconnectionAttempts = 5;
  
  ws.onclose=()=>{
    reconnectionAttempts++;
    if(reconnectionAttempts <= maxReconnectionAttempts){
      setTimeout(()=>{
        try {
          connect();
        } catch (e) {
          console.error('Reconnection failed:', e);
        }
      }, 3000);
    }
  };
}
connect();

// theme toggle
themeToggle.addEventListener('click',()=>{
  const isLight=document.documentElement.classList.toggle('light-theme');
  localStorage.setItem('theme',isLight?'light':'dark');
  const sun=themeToggle.querySelector('.icon-sun'),moon=themeToggle.querySelector('.icon-moon');
  if(isLight){sun.style.opacity=1;moon.style.opacity=0;}else{sun.style.opacity=0;moon.style.opacity=1;}
});
// Use dark theme by default
if(localStorage.getItem('theme')==='light'){
  document.documentElement.classList.add('light-theme');
  themeToggle.querySelector('.icon-sun').style.opacity=1;
  themeToggle.querySelector('.icon-moon').style.opacity=0;
} else {
  themeToggle.querySelector('.icon-sun').style.opacity=0;
  themeToggle.querySelector('.icon-moon').style.opacity=1;
}

</script>
</body>
</html>
